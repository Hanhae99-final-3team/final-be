# 멍냥마켓
## ![image](https://user-images.githubusercontent.com/72599761/193500030-784be94c-d5c9-438f-b4af-2adce019af44.png) 프로젝트 소개
![image](https://user-images.githubusercontent.com/72599761/193499776-c528e11a-fa77-47f8-a7d7-65b40d1f4f71.png)

![image](https://user-images.githubusercontent.com/72599761/193501894-dc660188-fafa-48b8-bd03-52fb13e6e9ad.png)  소중한 반려동물을 위해, 안 쓰는 반려동물 용품, 멍냥마켓에서 손쉽게 직거래하세요!  <br> 
![image](https://user-images.githubusercontent.com/72599761/193501899-201d9b77-64c1-48bd-9cc5-c21c68319bfd.png)  반려동물의 취향에 맞지 않는 물건들이 있거나, 방치되고 있는 반려동물 용품들이 있다면, 사진을 올려 판매 가능한 웹 애플리케이션<br> 

### ![image](https://user-images.githubusercontent.com/72599761/193500030-784be94c-d5c9-438f-b4af-2adce019af44.png) [멍냥마켓 바로가기](https://meongnyang-market.com/)
###### [Front-End Github](https://github.com/Hanhae99-final-3team/final_FE)
###### [Back-End Github](https://github.com/Hanhae99-final-3team/final-be)
<hr>

## ⚙️ 서비스 아키텍처 
![서비스 아키텍처_v2 0](https://user-images.githubusercontent.com/89531122/194447149-a98b4332-1281-49d6-bde2-4d6139a4a646.png)

<hr>

## 📅 프로젝트 기간   

기간 : 2022년 8월 26일 ~ 2022년 10월 7일(6주)

<hr>

## ✨ 주요 기능  
|페이지|API 및 관련 메서드|
|---|---|
|로그인|✅로그인<br>✅카카오 로그인<br>✅토큰 재발행|
|회원가입|✅회원가입<br>✅아이디 중복 검사<br>✅닉네임 중복 검사|
|메인페이지|✅상품 리스트 조회<br>✅카테고리에 따른 분류 조회|
|상품 상세 페이지|✅단일 상품 조회<br>✅조회한 상품 쿠키 발급<br>✅조회 수 증가<br>✅평균 가격 호출<br>✅상품 찜 기능<br>✅댓글 CRUD|
|상품 등록 페이지|✅상품(게시글) CRUD<br>✅이미지 다중 업로드|
|검색 페이지|✅상품 검색<br>✅인기 검색어<br>✅최근 검색어<br>✅최근 검색어 자동 저장 토글 ON/OFF<br>✅최근 검색어 자동 저장 토글 값 가져오기<br>✅최근 검색어 전체 삭제<br>✅최근 검색어 개별 삭제<br>✅검색어 자동 완성|
|검색 결과 페이지|✅인기순 정렬<br>✅최신순 정렬<br>|
|마이 페이지|✅로그아웃<br>✅마이페이지 차트<br>|
|내가 쓴 글|✅내가 쓴 글<br>|
|찜 리스트|✅찜 리스트<br>|
|최근 본 상품|✅최근 본 상품<br>|

<hr>

## 🛠 기술 스택

<div align=center> 
  <img src="https://img.shields.io/badge/java-007396?style=for-the-badge&logo=java&logoColor=white"> 
  <img src="https://img.shields.io/badge/spring-6DB33F?style=for-the-badge&logo=spring&logoColor=white"> 
  <img src="https://img.shields.io/badge/Spring boot-6DB33F?style=for-the-badge&logo=Spring boot&logoColor=black"> 
  <img src="https://img.shields.io/badge/gradle-02303A?style=for-the-badge&logo=gradle&logoColor=white"> 
  <br> 

  <img src="https://img.shields.io/badge/Spring Security-6DB33F?style=for-the-badge&logo=Spring Security&logoColor=black"> 
  <img src="https://img.shields.io/badge/kakaologin-FFCD00?style=for-the-badge&logo=kakao&logoColor=black"> 
  <img src="https://img.shields.io/badge/Json web tokens-000000?style=for-the-badge&logo=Json web tokens&logoColor=white"> 
  <br>
  
  <img src="https://img.shields.io/badge/querydsl-2599ED?style=for-the-badge&logo=querydsl&logoColor=white">
  <img src="https://img.shields.io/badge/sock JS-000000?style=for-the-badge&logo=sockjs&logoColor=black"> 
  <img src="https://img.shields.io/badge/stomp-FF6C37?style=for-the-badge&logo=stomp&logoColor=white">
  <img src="https://img.shields.io/badge/websocket-010101?style=for-the-badge&logo=websocket&logoColor=white">
  <img src="https://img.shields.io/badge/redis-DC382D?style=for-the-badge&logo=redis&logoColor=white"> 
  <br>
  
  <img src="https://img.shields.io/badge/amazonaws-232F3E?style=for-the-badge&logo=amazonaws&logoColor=white"> 
  <img src="https://img.shields.io/badge/amazonec2-FF9900?style=for-the-badge&logo=amazonec2&logoColor=white">
  <img src="https://img.shields.io/badge/amazonrds-527FFF?style=for-the-badge&logo=amazonrds&logoColor=white">
  <img src="https://img.shields.io/badge/mysql-4479A1?style=for-the-badge&logo=mysql&logoColor=white">
  <img src="https://img.shields.io/badge/amazonS3-569A31?style=for-the-badge&logo=amazons3&logoColor=white"> 
  <br>
  
  <img src="https://img.shields.io/badge/intellijidea-000000?style=for-the-badge&logo=intellijidea&logoColor=white"> 
  <img src="https://img.shields.io/badge/sourcetree-0052CC?style=for-the-badge&logo=sourcetree&logoColor=white"> 
  <img src="https://img.shields.io/badge/postman-FF6C37?style=for-the-badge&logo=postman&logoColor=white"> 
  <img src="https://img.shields.io/badge/swagger-85EA2D?style=for-the-badge&logo=swagger&logoColor=white"> 
  <img src="https://img.shields.io/badge/slack-4A154B?style=for-the-badge&logo=slack&logoColor=white"> 
  <img src="https://img.shields.io/badge/notion-000000?style=for-the-badge&logo=notion&logoColor=white"> 
  <br> 

  <img src="https://img.shields.io/badge/github-181717?style=for-the-badge&logo=github&logoColor=white">
  <img src="https://img.shields.io/badge/git-F05032?style=for-the-badge&logo=git&logoColor=white">
  <br> 
</div>

<br>
<hr>

## 🗺 API 설계 

### [API 설계 보러가기](https://heather-warbler-33c.notion.site/API-fb817bdee95f4d03bf54e69108d0dfa8)
##### [Swagger UI로 확인하기](https://fabius-bk.shop/swagger-ui/index.html#/)

<hr>

## 📝 ERD 설계 

### [ERD 설계 보러가기](https://www.erdcloud.com/d/uJr3xXdEqhSJFLha3)

<hr>

## 🔨 기술적 의사 결정

| 적용 기술                     | 적용 목적                                                                                                                          |
| ----------------------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| Swagger | API 명세서를 보다 보기 쉽게 정리하고, API들에 대한 직접적인 테스트를 BE뿐만 아니라 FE, 디자이너 팀원들도 가능하도록 도입 |
| Spring Cache + Scheduler | 상품 상세 조회 시 평균 가격 호출 메서드(조회하는 상품이 속한 itemCategory에 등록된 상품들의 평균 가격을 불러오는 메서드) 개선 위함 |
| Qeurydsl | - 상품 리스트 조회 메서드를 동적 쿼리로 구현하기 위함 <br> - JPA의 장점을 지키며 검색 기능 향상을 위한 MySQL의 MATCH() AGAINST() 함수 적용 위함 |

<hr>

## 🎯 트러블 슈팅 

### 1. 평균 가격 계산 메서드 개선 

|구분|설명|
|:---:|---|
|문제<br>상황| 상품 상세 페이지 내 '가격 비교하기' 차트용 평균 가격 계산을 매 상품 조회 시 마다 실시 |
|문제<br>원인|서비스에서 상품 조회가 굉장히 빈번하게 발생되고 동일한 데이터를 넘겨주면 되는 작업임에도매번 계산을 하게 끔 설정한 것이 문제였습니다.|
|문제<br>해결| 첫 번째로 전체 상품의 평균 가격을 계산하는 것이 아닌 해당 itemCategory에 등록된 최신 100개 상품들의 평균 가격을 계산하게 끔 수정하였습니다.<br>사용자 입장에서 평균 가격이 거래에 있어 유용한 지표로서 작용될 수 있으나 1억 건의 데이터가 존재할 때 1억 개의 상품들의 평균 가격이나 최신 100개 상품의 평균 가격이나 서비스 이용에 큰 차이를 느끼지 못할 것이라 판단하였습니다. 오히려 최신 100개 상품 만으로 평균 가격을 도출하는 것이 소비자 입장에서 해당 상품들의 가격 동향을 파악하기에 유용할 수 있을 것이라 생각하였습니다.<br><br>두 번째로 **Spring Cache**를 도입하여 최초의 상품 조회에서만 평균 가격을 계산하고 그 뒤로 일정 시간 동안은 캐시 데이터로 저장된 평균 가격을 가져오게 끔 수정하였습니다.이를 바탕으로 매 상품 조회 마다 평균 가격을 계산하던 불필요한 반복 작업을 확 줄일 수 있었습니다.<br>하지만 순수 Spring Cache로는 주기적인 평균 가격 값의 업데이트 불가하였기에 Scheduler를 추가 적용하여 주기적으로 평균 가격에 대한 캐시 데이터를 갱신시키도록 하였습니다.|
|해결<br>결과|기존 상품 조회 시 마다 반복적으로 평균 가격을 계산하는 메서드를 캐시를 활용하여 훨씬 더 효율적으로 동작하게 끔 리팩터링 할 수 있었습니다.<br><br><img width="405" alt="image" src="https://user-images.githubusercontent.com/108924263/194000700-74f0d035-3d57-4ad9-afdf-5c1f3eca4775.png">|

### 2. 검색 메서드 개선 

|구분|설명|
|:---:|---|
|문제<br>상황|상품 검색 시 Full Table Scan이 발생하여 서비스 확장 시 검색 기능의 성능 저하 우려|
|문제<br>원인|기존 검색 기능은 like %input%으로 구현하였었습니다. 이럴 경우 의도했던 검색은 가능하나 Full Table Scan으로 동작하는 것이 문제의 원인이었습니다.|
|문제<br>해결|Full Text Index를 생성하여 MySQL의 MATCH() AGAINST() 함수를 활용해 기존의 like 쿼리문을 개선하였습니다. 하지만 JPQL에서는 MATCH() 함수를 지원하지 않았기 Custom MysqlDialect Class 생성하여 Querydsl를 바탕으로 기존 검색 메서드를 리팩터링하였습니다.
|해결<br>결과|현재 프로젝트 DB Table row는 많지 않아 큰 차이를 확인 할 수 없었으나 Test용 DB를 생성하여 약 100만 건의 더미데이터를 활용하여 성능 테스트를 해본 결과 Full Text Index를 바탕으로 개선한 쿼리문은 기존 대비 약 20%의 향상된 성능을 보였으며 프로젝트에 적용한 검색 메서드에서도 이와 유사한 결과를 확인할 수 있었습니다.<br><br><img width="500" alt="화면 캡처 2022-10-05 160731" src="https://user-images.githubusercontent.com/108924263/194001309-25e28f5a-dc3f-44cb-9f75-00fefbc52a04.png">|

###3. https와 웹소켓 통신
|구분|설명|
|:---:|---|
|문제<br>상황|ws에서 wss로 https 통신을 하기 위해서 endpoint를 설정해 주었음에도 프론트에서 보낸 웹소켓 요청이 서버까지 닿지 않음. 
|문제<br>원인|기존은 http 통신으로 하였기에 배포를 할 때, https 통신으로 바뀌면서 웹소켓 뿐만 아니라 서버의 요청도 바꿀 필요가 있었음. 
|문제<br>해결|채팅 서버를 따로 분리 하기 위해서 메인 서버는 https를 통해서 통신 했지만, 채팅쪽 서버는 http상태로 유지한 것이 문제. 일단 기존의 서버에 연결을 시켜 놓고 차후 서버 쪽 서버를 https로 변경 후 변경시키기로 함
|해결<br>결과|무사히 클라이언트 요청이 서버로 통신이 되고 웹소켓이 통신도 가능함.
<hr>

## 👩‍💻 유저 피드백 및 개선 사항 
2022년 09월 29일 수요일 ~ 2022년 10월 1일까지 멍냥마켓 서비스에 대해 48명 유저의 피드백을 받고 서비스 개선을 진행했습니다.

#### [[유저 피드백 1] 상품 등록 시 제목 글자 수 제한 및 가격 제한이 없어 영역을 벗어나거나 과도한 평균 가격이 발생되는 에러 (8명) ](https://github.com/Hanhae99-final-3team/final-be/pull/101)
#### [[유저 피드백 2] 로그인 이후 토큰 재발급이 이뤄지지 않아 일정 시간 이후 권한이 필요한 작업들이 정상작동하지 않는 에러 (6명) ](https://github.com/Hanhae99-final-3team/final-be/pull/96)
<br>
<hr>
<br>

## 🐶 추가하고 싶은 기능 

<hr>

|기능|설명
|---|---|
|webSocket 채팅|webSocket을 활용해 클라이언트와의 양방향 통신을 통한 실시간 채팅을 구현함으로, sock.js를 이용해 지원하지 않는 IE나 구글 크롬 버전에서도 사용이 가능하게 하며, Stomp로 subscribe를 관리해주기 위해서 도입.|
|redis| redis를 통해서 채팅의 subscribe를 관리해줌으로 서버에 대한 부담을 줄이고, 차후 서버 증설 등에 다중 서버에 대한 문제를 해결 할 수 있으며, redis에 토큰을 담거나 redis 캐쉬 등을 이용해 더 범용성 넓은 기능들을 사용하기 위해서 도입.|
|sse 알람기능|sse를 통해서 webSoket보다는 가볍고 알람기능은 클라이언트에서 요청이 따로 필요가 없기에 sse를 통해서 댓글이나 메세지가 올 경우 알람을 보낼 수 있도록 설계|
|ElasticSearch|검색 메서드 개선 및 BE 단에서의 향상된 검색어 자동 완성 기능 구현을 위하여 추가 학습 후 적용시켜 보고 싶습니다.|

## 👨‍👩‍👧 팀원 소개  

|이름|깃허브 주소|포지션|
|---|---|---|
|이회섭|[HoisubLee의 github](https://github.com/HoisubLee)|Backend|
|김재영|[fabius96의 github](https://github.com/fabius96)|Backend|
|한종혁|[1argeD의 github](https://github.com/1argeD)|Backend|
|김수정|[crystal993의 github](https://github.com/crystal993)|Frontend|
|김주형|[KoreanCodingMachine의 github](https://github.com/KoreanCodingMachine)|Frontend|
|양명현|[thisLife-hyeon의 github](https://github.com/thisLife-hyeon)|UI/UX|

<hr>
